app-id: org.equicord.equibop

runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: *runtime-version
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20

command: startequibop
separate-locales: false

finish-args:
  - --socket=pulseaudio
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --talk-name=org.kde.StatusNotifierWatcher
  - --own-name=org.equicord.equibop.StatusNotifierItem   # Needed for libvesktop native tray
  - --talk-name=com.canonical.AppMenu.Registrar
  - --device=all   # Needed for GPU acceleration and the webcam
  - --filesystem=xdg-videos:ro
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-download   # This and the above two are used for drag-n-drop, and download managing
  - --filesystem=xdg-run/pipewire-0:ro   # Pipewire interfacing
  - --filesystem=xdg-run/speech-dispatcher:ro   # For TTS and VcNarrator
  - --filesystem=~/.steam   # Needed for SteamOS integration, as the XDG OpenURL portal doesn't work properly in Game Mode. We only need ~/.steam/steam.pipe but Flatpak can't correctly mount just that: 'File "/home/deck/.steam/steam.pipe" has unsupported type 0o10000'
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons   # This is used to show the correct cursor on Wayland

modules:
  - name: Equibop
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
    build-commands:
      - tar xzf node_modules.tar.gz

      - bun-build/bun run build

      - export PATH="$PWD/bun-build:$PATH" && . /usr/lib/sdk/node20/enable.sh && node_modules/.bin/electron-builder
        --dir --linux dir --config.electronDist=node_modules/electron/dist

      - |
        if [ -d 'dist/linux-unpacked' ]; then
          DIST_DIR='dist/linux-unpacked'
        elif [ -d 'dist/linux-arm64-unpacked' ]; then
          DIST_DIR='dist/linux-arm64-unpacked'
        else
          echo 'Error: Could not find unpacked directory'
          exit 1
        fi

        if [ "$FLATPAK_ARCH" = 'x86_64' ]; then
            install -Dm755 arrpc-bun-linux-x64 /app/bin/arrpc-bun
        elif [ "$FLATPAK_ARCH" = 'aarch64' ]; then
            install -Dm755 arrpc-bun-linux-arm64 /app/bin/arrpc-bun
        fi

        install -Dm644 build/icon.svg /app/share/icons/hicolor/scalable/apps/org.equicord.equibop.svg

        desktop-file-edit --set-key=Exec --set-value='startequibop %U' build/org.equicord.equibop.desktop
        install -Dm644 build/org.equicord.equibop.desktop /app/share/applications/org.equicord.equibop.desktop
        install -Dm755 startequibop /app/bin/startequibop
        install -D org.equicord.equibop.metainfo.xml -t /app/share/metainfo/

        cp --reflink=auto -r "$DIST_DIR" /app/bin/equibop

    sources:
      - type: file
        path: startequibop

      - type: archive
        url: https://api.github.com/repos/Equicord/Equibop/tarball/v3.1.7
        dest-filename: equibop-v3.1.7.tar.gz
        sha512: 8c79ef54643d198586fa2ef819fa11af6dd1d952b897a2903eab3bba7b4255461691d1ceb66b26031884a48c7e5e152b426a2fb995fdff6f47a861bf9cfb8e1f
        strip-components: 1
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .tarball_url
          is-main-source: true

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.7/node_modules-x64.tar.gz
        dest-filename: node_modules.tar.gz
        sha512: 340c3e6a782e75c60098731b2a18d28ea06a209bf7b924ad904495ae7dd65f8ea901a2dc7b8b7ed33e358f5dc27ccade8d3f9e3f0856f30994a0f7b560535b92
        only-arches: [x86_64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "node_modules-x64.tar.gz") | .browser_download_url

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.7/node_modules-arm64.tar.gz
        dest-filename: node_modules.tar.gz
        sha512: 8f3aa1cc6ea69c28f9f1dc8a0d2047c702c53a69345faac9a6a54e32477f01908c2b8099f7d844aba2298057be7e2bd1cf78e7ed5ee1fdd41540f118eb566321
        only-arches: [aarch64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "node_modules-arm64.tar.gz") | .browser_download_url

      - type: archive
        url: https://github.com/electron/electron/releases/download/v40.0.0/electron-v40.0.0-linux-x64.zip
        sha512: 016b10ab8b813fd1cdd78a853db92efd9f7f893f3f03efb2b8f5bde0834640660e0487df6d19b417ea098a59b1ff2256fd71ac9a3c2cdb7b3768fb65a094b8ea
        dest: node_modules/electron/dist
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v40.0.0/electron-v40.0.0-linux-arm64.zip
        sha512: 9f31569598764d94463d543f91f45978f2da3a7d1a42a937059edc8744e47ab1bc5ed86c0303100754b55c0ca379e6a184df0431c54eb0a4156cf4f32428573a
        dest: node_modules/electron/dist
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-x64.zip
        sha512: 6a6673c33817257537afdf16f416d0cd2c46f0dc52019930e986f7e206536f956ae37d56657e9d0a60f125eae792de3eb19cffa0c5ce4371a98cf5ae67ba9127
        dest: bun-build
        only-arches: [x86_64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/oven-sh/bun/releases/latest
          version-query: .tag_name | sub("bun-v"; "")
          url-query: .assets[] | select(.name == "bun-linux-x64.zip") | .browser_download_url

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-aarch64.zip
        sha512: 09c43605e8b0c418cf89e04e29dd480100498e0a718b3e63b2cfa4331727e2fcedfe8fafa91900e8b89f9b8d16cc33dd13f3b5e7dc23a9abcdcbcd442ba623b1
        dest: bun-build
        only-arches: [aarch64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/oven-sh/bun/releases/latest
          version-query: .tag_name | sub("bun-v"; "")
          url-query: .assets[] | select(.name == "bun-linux-aarch64.zip") | .browser_download_url

      - type: file
        url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.4/arrpc-bun-linux-x64
        sha512: f7fdd50cb339f57d86a87e4b99c576e38f3ec4d98be74e40a50876ca43451955993f4c2ed2c7a4cd0b91dd263c450a38e97f336974a430c3614b049e26aee80e
        dest-filename: arrpc-bun-linux-x64
        only-arches: [x86_64]

      - type: file
        url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.4/arrpc-bun-linux-arm64
        sha512: 19da5dc3d7da68044f03714de3176a36683ed817d2a3c67d47d373e8911bf5f9162ad49cedfaca7c6137f027c418a410e1e5d636ff803340ea74aa07aa9515bf
        dest-filename: arrpc-bun-linux-arm64
        only-arches: [aarch64]

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.7/org.equicord.equibop.metainfo.xml
        sha512: 7dd5f14f7aefb05bb691bd647121df8e8d2238612f4f6db3c7f90296c572de83a3e562431ed4d2b05bc9819145d270817f26a4184e8253437ab3556ac6fd7ecf
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "org.equicord.equibop.metainfo.xml")
            | .browser_download_url
