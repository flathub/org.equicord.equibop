app-id: org.equicord.equibop

runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: *runtime-version
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20

command: startequibop
separate-locales: false

finish-args:
  - --socket=pulseaudio
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --talk-name=org.kde.StatusNotifierWatcher
  - --own-name=org.equicord.equibop.StatusNotifierItem   # Needed for libvesktop native tray
  - --talk-name=com.canonical.AppMenu.Registrar
  - --device=all   # Needed for GPU acceleration and the webcam
  - --filesystem=xdg-videos:ro
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-download   # This and the above two are used for drag-n-drop, and download managing
  - --filesystem=xdg-run/pipewire-0:ro   # Pipewire interfacing
  - --filesystem=xdg-run/speech-dispatcher:ro   # For TTS and VcNarrator
  - --filesystem=~/.steam   # Needed for SteamOS integration, as the XDG OpenURL portal doesn't work properly in Game Mode. We only need ~/.steam/steam.pipe but Flatpak can't correctly mount just that: 'File "/home/deck/.steam/steam.pipe" has unsupported type 0o10000'
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons   # This is used to show the correct cursor on Wayland

modules:
  - name: Equibop
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
    build-commands:
      - tar xzf node_modules.tar.gz

      - bun-build/bun run build

      - export PATH="$PWD/bun-build:$PATH" && . /usr/lib/sdk/node20/enable.sh && node_modules/.bin/electron-builder
        --dir --linux dir --config.electronDist=node_modules/electron/dist

      - |
        if [ -d 'dist/linux-unpacked' ]; then
          DIST_DIR='dist/linux-unpacked'
        elif [ -d 'dist/linux-arm64-unpacked' ]; then
          DIST_DIR='dist/linux-arm64-unpacked'
        else
          echo 'Error: Could not find unpacked directory'
          exit 1
        fi

        mkdir -p "$DIST_DIR/resources/app.asar.unpacked/static/dist"
        if [ "$FLATPAK_ARCH" = 'x86_64' ]; then
            cp arrpc-bun-linux-x64 "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc"
        elif [ "$FLATPAK_ARCH" = 'aarch64' ]; then
            cp arrpc-bun-linux-arm64 "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc"
        fi
        chmod +x "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc"

        install -Dm644 build/icon.svg /app/share/icons/hicolor/scalable/apps/org.equicord.equibop.svg

        desktop-file-edit --set-key=Exec --set-value='startequibop %U' build/org.equicord.equibop.desktop
        install -Dm644 build/org.equicord.equibop.desktop /app/share/applications/org.equicord.equibop.desktop
        install -Dm755 startequibop /app/bin/startequibop
        install -D org.equicord.equibop.metainfo.xml -t /app/share/metainfo/

        cp --reflink=auto -r "$DIST_DIR" /app/bin/equibop

    sources:
      - type: file
        path: startequibop

      - type: archive
        url: https://api.github.com/repos/Equicord/Equibop/tarball/v3.1.5
        dest-filename: equibop-v3.1.5.tar.gz
        sha512: 34133a24b5f6e86edadf42538d55408829d408dc6c4a4157dbf3c28fa86ef6b1cbc78b7bf6709b5c11b08f744be7ad364011be9734e0e8e9be0f6a3d651572d4
        strip-components: 1
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .tarball_url
          is-main-source: true

      - type: patch
        path: sandboxFix.patch

      - type: patch
        path: gitHash.patch

      - type: patch
        path: arrpcPath.patch

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.5/node_modules-x64.tar.gz
        dest-filename: node_modules.tar.gz
        sha512: 151632cf9602fa244100c8856e475d7844678200134a49d32c443ecd33601e6002a32d27b136c81adb9b9304740f9f7a1069f3fe41a977b89ac668d8f9ed9334
        only-arches: [x86_64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "node_modules-x64.tar.gz") | .browser_download_url

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.5/node_modules-arm64.tar.gz
        dest-filename: node_modules.tar.gz
        sha512: bb3d0e8e2f00c0cef05055c0cd3768c5c89d23129e71154c191cd871f2cf4711dddf0617e4319bc6dfc8557675ae5da20d450094f2cee323557feec75fd31377
        only-arches: [aarch64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "node_modules-arm64.tar.gz") | .browser_download_url

      - type: archive
        url: https://github.com/electron/electron/releases/download/v39.2.1/electron-v39.2.1-linux-x64.zip
        sha512: aa22f877c482ec3be3a59545894dda78370a7b62535eb3571475cc76b41fc4a2799208ae6d9637de1302c954b8a1a020534c996a1f1de0954d52375d72414a90
        dest: node_modules/electron/dist
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v39.2.1/electron-v39.2.1-linux-arm64.zip
        sha512: 5e56357a3be7a9ec93e337531260f9277cd3275e63135de665c6317b7ac53b489c316e83512efe72477c4da03bb2c5eb9ce29a7ae7de4d9665cc612477ce5148
        dest: node_modules/electron/dist
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.5/bun-linux-x64.zip
        sha512: d4c09bb174717d782beca3b544fcc940b21fd544ac2b0288bdd1bc4c2453a2433cfa630e18a1fbe19a379c41c7e232d039764a14585fbff9a4922d9d81a81523
        dest: bun-build
        only-arches: [x86_64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/oven-sh/bun/releases/latest
          version-query: .tag_name | sub("bun-v"; "")
          url-query: .assets[] | select(.name == "bun-linux-x64.zip") | .browser_download_url

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.5/bun-linux-aarch64.zip
        sha512: d67c0909787e9d6124135fcca1486d9c657ad0540537b2d721b7c8d2a66e02776792769a51e80d56a3e0c2fb041ebc8df6106fd0e6ff78ca9590b47d29ed3945
        dest: bun-build
        only-arches: [aarch64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/oven-sh/bun/releases/latest
          version-query: .tag_name | sub("bun-v"; "")
          url-query: .assets[] | select(.name == "bun-linux-aarch64.zip") | .browser_download_url

      - type: file
        url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.3/arrpc-bun-linux-x64
        sha512: e3825ed036fee71e8478fa1c2f4d9478cf1960121dbd2436edec69d8086deb3bfc3486d9d773764e98fb9a95e165b49ec48571661524ab919ba62179590999cd
        dest-filename: arrpc-bun-linux-x64
        only-arches: [x86_64]

      - type: file
        url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.3/arrpc-bun-linux-arm64
        sha512: d2dd56bf53d3aa53958089c369a753502f1f435905ba04b318f567aca5d09507167beabaeae82236cacd97070e3bad7f5b980f5890af2f781a3d09321067d9d5
        dest-filename: arrpc-bun-linux-arm64
        only-arches: [aarch64]

      - type: file
        url: https://github.com/Equicord/Equibop/releases/download/v3.1.5/org.equicord.equibop.metainfo.xml
        sha512: b0ed06c41faa04d7876d202e384bab37658480126a47a2804a81979c5e778743b644861f93a4bd5e31149dbd3ba2655ed3f494e2ee5a064c59a3f18f7f5a2aee
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Equicord/Equibop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .assets[] | select(.name == "org.equicord.equibop.metainfo.xml") | .browser_download_url
