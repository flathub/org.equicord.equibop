app-id: org.equicord.equibop

runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: *runtime-version
sdk-extensions:
    - org.freedesktop.Sdk.Extension.node20

command: startequibop
separate-locales: false

finish-args:
    - --socket=pulseaudio
    - --socket=fallback-x11
    - --socket=wayland
    - --share=ipc
    - --share=network
    - --talk-name=org.kde.StatusNotifierWatcher # Tray functionalities on KDE
    - --talk-name=org.freedesktop.StatusNotifierWatcher # Tray functionalities on other DEs
    - --own-name=org.kde.* # Needed for libvesktop native tray
    - --talk-name=com.canonical.AppMenu.Registrar
    - --device=all # Needed for GPU acceleration and the webcam
    - --filesystem=xdg-videos:ro
    - --filesystem=xdg-pictures:ro
    - --filesystem=xdg-download # This and the above two are used for drag-n-drop, and download managing
    - --filesystem=xdg-run/pipewire-0:ro # Pipewire interfacing
    - --filesystem=xdg-run/speech-dispatcher:ro # For TTS and VcNarrator
    - --filesystem=~/.steam # Needed for SteamOS integration, as the XDG OpenURL portal doesn't work properly in Game Mode. We only need ~/.steam/steam.pipe but Flatpak can't correctly mount just that: 'File "/home/deck/.steam/steam.pipe" has unsupported type 0o10000'
    - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons # This is used to show the correct cursor on Wayland

modules:
    - name: Equibop
      buildsystem: simple
      build-options:
          strip: false
          no-debuginfo: true
      build-commands:
          - tar xzf node_modules.tar.gz

          - bun-build/bun run build

          - export PATH="$PWD/bun-build:$PATH" && . /usr/lib/sdk/node20/enable.sh && node_modules/.bin/electron-builder --dir --linux dir --config.electronDist=node_modules/electron/dist

          - |
              if [ -d 'dist/linux-unpacked' ]; then
                DIST_DIR='dist/linux-unpacked'
              elif [ -d 'dist/linux-arm64-unpacked' ]; then
                DIST_DIR='dist/linux-arm64-unpacked'
              else
                echo 'Error: Could not find unpacked directory'
                exit 1
              fi

              mkdir -p "$DIST_DIR/resources/app.asar.unpacked/static/dist"
              if [ "$FLATPAK_ARCH" = 'x86_64' ]; then
                  cp arrpc-bun-linux-x64 "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc-linux-x64"
              elif [ "$FLATPAK_ARCH" = 'aarch64' ]; then
                  cp arrpc-bun-linux-arm64 "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc-linux-arm64"
              fi
              chmod +x "$DIST_DIR/resources/app.asar.unpacked/static/dist/arrpc-"*

              install -Dm644 build/icon.svg /app/share/icons/hicolor/scalable/apps/org.equicord.equibop.svg

              desktop-file-edit --set-key=Exec --set-value='startequibop %U' build/org.equicord.equibop.desktop
              install -Dm644 build/org.equicord.equibop.desktop /app/share/applications/org.equicord.equibop.desktop
              install -Dm755 startequibop /app/bin/startequibop
              install -D build/org.equicord.equibop.metainfo.xml -t /app/share/metainfo/

              cp --reflink=auto -r "$DIST_DIR" /app/bin/equibop

      sources:
          - type: file
            path: startequibop

          - type: archive
            url: https://api.github.com/repos/Equicord/Equibop/tarball/v3.1.2
            dest-filename: equibop-v3.1.2.tar.gz
            sha512: 56e18001a100ebc6487a6da3c660fb6567dace092cb6ce74057b940d9eab277f3c5ba7290abfecca89b348bd6a81ea2ad3115dd3a66557f8f455fb5296c80898
            strip-components: 1
            x-checker-data:
                type: json
                url: https://api.github.com/repos/Equicord/Equibop/releases/latest
                version-query: .tag_name | sub("v"; "")
                url-query: .tarball_url
                is-main-source: true

          - type: patch
            path: sandboxFix.patch

          - type: patch
            path: gitHash.patch

          - type: patch
            path: arrpcPath.patch

          - type: file
            url: https://github.com/Equicord/Equibop/releases/download/v3.1.2/node_modules-x64.tar.gz
            dest-filename: node_modules.tar.gz
            sha512: 32e6071db08be3779469ce36353ef7071ff0e1460f97c0daec4a2f984a410787cf7a33962222a861dce4b0c0e4f13e7b20d3c8ec171d1a2b63c871c440e3a317
            only-arches: [x86_64]
            x-checker-data:
                type: json
                url: https://api.github.com/repos/Equicord/Equibop/releases/latest
                version-query: .tag_name | sub("v"; "")
                url-query:
                    .assets[] | select(.name == "node_modules-x64.tar.gz")
                    | .browser_download_url

          - type: file
            url: https://github.com/Equicord/Equibop/releases/download/v3.1.2/node_modules-arm64.tar.gz
            dest-filename: node_modules.tar.gz
            sha512: cc3e0a69c02fc2a73ed4e6bd63efddc37c73dda1e0bce89b9b26ad31fd8e21b3ad7c60e16ac3f54753ee00df0313b5ba5ed94f6b625cc33e8595db0ed58d6714
            only-arches: [aarch64]
            x-checker-data:
                type: json
                url: https://api.github.com/repos/Equicord/Equibop/releases/latest
                version-query: .tag_name | sub("v"; "")
                url-query:
                    .assets[] | select(.name == "node_modules-arm64.tar.gz")
                    | .browser_download_url

          - type: archive
            url: https://github.com/electron/electron/releases/download/v39.2.1/electron-v39.2.1-linux-x64.zip
            sha512: aa22f877c482ec3be3a59545894dda78370a7b62535eb3571475cc76b41fc4a2799208ae6d9637de1302c954b8a1a020534c996a1f1de0954d52375d72414a90
            dest: node_modules/electron/dist
            only-arches: [x86_64]

          - type: archive
            url: https://github.com/electron/electron/releases/download/v39.2.1/electron-v39.2.1-linux-arm64.zip
            sha512: 5e56357a3be7a9ec93e337531260f9277cd3275e63135de665c6317b7ac53b489c316e83512efe72477c4da03bb2c5eb9ce29a7ae7de4d9665cc612477ce5148
            dest: node_modules/electron/dist
            only-arches: [aarch64]

          - type: archive
            url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.2/bun-linux-x64.zip
            sha512: 9b33415f60066037c9d4e4afe58612f1e1ba826dc8d21e4d959b553c9dd71ae301c5c6646afdb77ae83ec7ca057d3ed6625fe347d74badc30c487735f9a1d8cb
            dest: bun-build
            only-arches: [x86_64]
            x-checker-data:
                type: json
                url: https://api.github.com/repos/oven-sh/bun/releases/latest
                version-query: .tag_name | sub("bun-v"; "")
                url-query: .assets[] | select(.name == "bun-linux-x64.zip") | .browser_download_url

          - type: archive
            url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.2/bun-linux-aarch64.zip
            sha512: c9faa81ff20e4365081d7bac1d7ec6677d4e912d7ad69f885532dd43cdf150f495ce8fd152b8218bff716adc1a026fb10948b74e9e1b7d82c7ae7c467fc59a8a
            dest: bun-build
            only-arches: [aarch64]
            x-checker-data:
                type: json
                url: https://api.github.com/repos/oven-sh/bun/releases/latest
                version-query: .tag_name | sub("bun-v"; "")
                url-query: .assets[] | select(.name == "bun-linux-aarch64.zip") | .browser_download_url

          - type: file
            url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.1/arrpc-bun-linux-x64
            sha512: b7082e7b77937b38ddf3a2f99068ddbe3e6e7f1953a2ff881c0d729be009b3560d0ef71cb11089ae068ad8b52048c232b661730c955b31f85d96316ca35f7389
            dest-filename: arrpc-bun-linux-x64
            only-arches: [x86_64]

          - type: file
            url: https://github.com/Creationsss/arrpc-bun/releases/download/v1.3.1/arrpc-bun-linux-arm64
            sha512: 51aaf370dd4fe3a60a588ec8caec9c37ef9c686e2414408c5c8558195fa27e97558c2bede4f8aa1f6a1d4549c1ce6a150a566b78ed58ae1d0d496bd9c38288d3
            dest-filename: arrpc-bun-linux-arm64
            only-arches: [aarch64]
